"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.SinkMap = void 0;

var _readableStream = _interopRequireDefault(require("readable-stream"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

class SinkMap extends Map {
  import(key, input, options) {
    const sink = this.get(key);

    if (!sink) {
      return null;
    }

    if (typeof sink === 'function') {
      const passThrough = new _readableStream.default.PassThrough({
        objectMode: true
      });
      Promise.resolve().then(async () => {
        const sinkInstance = await sink();
        this.set(key, sinkInstance);
        const origStream = sinkInstance.import(input, options);
        origStream.on('error', err => {
          passThrough.emit('error', err);
          passThrough.emit('end');
        });
        origStream.pipe(passThrough);
      });
      return passThrough;
    }

    return sink.import(input, options);
  }

}

exports.SinkMap = SinkMap;